import{initAudioContext as e,getAudioContext as t}from"./AudioEngine.js";import{Track as n}from"./Track.js";import{bufferToWav as a}from"./WavEncoder.js";let i,r=[],o=[],d=null,s=null,c=1;const l=60,u=.2;let m=[],p=1,f=[],h=!1,g=0,y=!1,v=null,E={start:0,end:8},x=60,L=120,b=4,w=!0,T=Array.from({length:8},(e,t)=>({name:`Pad ${t+1}`,buffer:null})),I=0,M=!0,B=null,S=[],k=null,R=!1,P={events:[],length:0};const C=document.getElementById("recordBtn"),N=document.getElementById("trackList"),$=document.getElementById("emptyState"),X=document.getElementById("xyPad"),D=document.getElementById("xyCursor"),A=document.getElementById("fxControls"),F=document.getElementById("noTrackSelectedMsg"),O=document.getElementById("selectedTrackName"),Y=document.querySelectorAll(".effect-btn"),q=document.getElementById("globalRateSlider"),U=document.getElementById("globalRateLabel"),z=document.getElementById("resampleBtn"),j=document.getElementById("loadAudioBtn"),G=document.getElementById("audioFileInput"),H=document.getElementById("bpmInput"),_=document.getElementById("gridSelect"),V=document.getElementById("snapToggleBtn"),Q=document.getElementById("timelineBody"),J=document.getElementById("timelineRuler"),W=document.querySelector(".timeline"),K=document.getElementById("loopToggleBtn"),Z=document.getElementById("timelineLoopOverlay"),ee=document.getElementById("padGrid"),te=document.getElementById("selectedPadLabel"),ne=document.getElementById("padLoadBtn"),ae=document.getElementById("padRecordBtn"),ie=document.getElementById("padQuantizeBtn"),re=document.getElementById("padPatternRecordBtn"),oe=document.getElementById("padPatternClearBtn"),de=document.getElementById("padFileInput"),se=document.getElementById("saveDrumPresetBtn"),ce=document.getElementById("loadDrumPresetBtn"),le=document.getElementById("drumPresetInput");function ue(){return 60/Math.max(1,L)}function me(){return ue()/Math.max(1,b)}function pe(e){const t=me();return t?Math.round(e/t)*t:e}function fe(e=null){return!!w&&!(e&&e.altKey)}function he(){V&&(V.innerText=w?"Snap: On":"Snap: Off",V.style.background=w?"#2a8a58":"#444")}function ge(){ie&&(ie.innerText=M?"Pad Quantize: On":"Pad Quantize: Off",ie.style.background=M?"#2a8a58":"#444")}function ye(){re&&(re.innerText=R?"Stop Pattern":"Record Pattern",re.style.background=R?"#ff4444":"#444")}function ve(){return parseInt(getComputedStyle(document.documentElement).getPropertyValue("--drum-row-height"),10)||120}function Ee(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=n,a.readAsDataURL(e)})}if(K&&K.addEventListener("click",()=>{y=!y,K.innerText=y?"Loop Region: On":"Loop Region: Off",K.style.background=y?"#2a8a58":"#d68a28",Ue(),h&&ze()}),q&&(q.addEventListener("input",e=>{const t=parseFloat(e.target.value);c=t,U.innerText=`${t.toFixed(2)}x`,r.forEach(e=>e.updateLivePlaybackRate(c))}),q.addEventListener("dblclick",()=>{q.value=1,c=1,U.innerText="1.00x",r.forEach(e=>e.updateLivePlaybackRate(c))})),H){const e=parseFloat(H.value);Number.isFinite(e)&&(L=e),H.addEventListener("change",e=>{const t=parseFloat(e.target.value);Number.isFinite(t)&&(L=Math.max(40,Math.min(240,t)),H.value=L,Ae())})}if(_){const e=parseInt(_.value,10);Number.isFinite(e)&&(b=e),_.addEventListener("change",e=>{const t=parseInt(e.target.value,10);b=Number.isFinite(t)?t:4,Ae()})}async function xe(){const t=e();if("suspended"===t.state&&await t.resume(),C.classList.contains("active"))i&&"inactive"!==i.state&&i.stop(),s&&(s.getTracks().forEach(e=>e.stop()),s=null),C.classList.remove("active"),C.innerHTML='● REC <span class="shortcut">(Space)</span>';else try{const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}},n=await navigator.mediaDevices.getUserMedia(e);s=n,i=new MediaRecorder(n),o=[],i.ondataavailable=e=>o.push(e.data),i.onstop=async()=>{const e=new Blob(o,{type:"audio/ogg; codecs=opus"}),n=await e.arrayBuffer();Be(await t.decodeAudioData(n))},i.start(),C.classList.add("active"),C.innerText="■ STOP (Space)"}catch(e){alert("Microphone Error: "+e.message)}}V&&(he(),V.addEventListener("click",()=>{w=!w,he()})),document.addEventListener("keydown",e=>{"Space"===e.code&&"INPUT"!==e.target.tagName&&(e.preventDefault(),xe())}),C.addEventListener("click",xe);const Le=["q","w","e","r","a","s","d","f"];function be(e){const t=Le.indexOf(e.toLowerCase());return-1===t?null:t}function we(e){if(I=Math.max(0,Math.min(T.length-1,e)),te){const e=Le[I]?Le[I].toUpperCase():"";te.innerText=`${T[I].name}${e?` (${e})`:""}`}document.querySelectorAll(".pad-btn").forEach(e=>{const t=parseInt(e.dataset.pad,10)===I;e.classList.toggle("selected",t)})}function Te(e){const t=document.querySelector(`.pad-btn[data-pad="${e}"]`);if(!t)return;const n=!!T[e].buffer;t.classList.toggle("loaded",n)}function Ie(t,n,a=!1){const i=e(),r=T[t];if(!r||!r.buffer)return;const o=i.createBufferSource();o.buffer=r.buffer,o.connect(i.destination);let d=i.currentTime+.01;if(n){const e=me();e>0&&(d=Math.ceil(d/e)*e)}o.start(d),a&&function(e,t){if(!R)return;const n=y?E.end-E.start:4*ue(),a=Math.max(u,n),i=t-g;let r=y?i-E.start:i;if(r=(r%a+a)%a,M){const e=me();e>0&&(r=Math.round(r/e)*e)}r<0||r>a||(P.length=a,Me(e,r,!0),Ae())}(t,d)}function Me(e,t,n=!1){const a=me(),i=a>0?Math.round(t/a)*a:t,r=parseFloat(i.toFixed(4));if(y||0!==P.length||(P.length=4*ue()),!n){const t=P.events.findIndex(t=>t.padIndex===e&&Math.abs(t.time-r)<5e-4);if(-1!==t)return P.events.splice(t,1),!1}return P.events.push({time:r,padIndex:e}),!0}function Be(t){$&&($.style.display="none");const a=Date.now(),i=`Loop ${r.length+1}`,o=new n(a,t,i);r.push(o),function(t){const n=document.createElement("div");n.className="loop-item",n.id=`track-${t.id}`,n.innerHTML=`\n        <button class="track-play-btn" id="play-btn-${t.id}">▶</button>\n        \n        <div class="loop-center">\n            \x3c!-- Name Input --\x3e\n            <input type="text" class="loop-name-input" value="${t.name}" id="name-${t.id}">\n            \n            <div class="loop-waveform">\n                <div class="waveform-bar" style="width:100%"></div>\n            </div>\n            \n            <div class="controls-row">\n                <div class="control-group">\n                    <span>Trim</span>\n                    <input class="slider-mini" type="range" min="0" max="100" value="0" data-id="${t.id}" data-type="start">\n                    <input class="slider-mini" type="range" min="0" max="100" value="100" data-id="${t.id}" data-type="end">\n                </div>\n                <div class="control-group">\n                    <span>Speed</span>\n                    <input class="slider-mini" type="range" min="0.1" max="2.0" step="0.05" value="1.0" data-id="${t.id}" data-type="speed" title="Double click to reset">\n                </div>\n            </div>\n        </div>\n\n        <button class="select-btn" id="sel-btn-${t.id}">EDIT FX</button>\n        <button class="delete-btn" data-id="${t.id}">✕</button>\n    `,n.querySelector(`#play-btn-${t.id}`).onclick=()=>function(t){e();const n=r.find(e=>e.id===t);if(!n)return;n.isPlaying?(n.stop(),Se(t,!1)):(n.play(c),Se(t,!0))}(t.id),n.querySelector(`#sel-btn-${t.id}`).onclick=()=>ke(t.id),n.querySelector(".delete-btn").onclick=()=>function(e){const t=r.find(t=>t.id===e);t&&t.destroy();r=r.filter(t=>t.id!==e),m=m.filter(t=>t.trackId!==e);const n=document.getElementById(`track-${e}`);n&&n.remove();d===e&&function(){d=null,F&&F.classList.remove("hidden");A&&A.classList.add("hidden");document.querySelectorAll(".loop-item").forEach(e=>e.classList.remove("selected")),document.querySelectorAll(".select-btn").forEach(e=>{e.classList.remove("active"),e.innerText="EDIT FX"})}();Ae()}(t.id);const a=n.querySelector(`#name-${t.id}`);a.addEventListener("change",e=>{t.name=e.target.value,d===t.id&&(O.innerText=t.name),Ae()}),a.addEventListener("keydown",e=>e.stopPropagation()),n.querySelectorAll('input[type="range"]').forEach(e=>{e.oninput=e=>{const n=parseFloat(e.target.value),a=e.target.dataset.type;"start"===a?(t.trimStart=n/100,t.isPlaying&&t.play(c)):"end"===a?(t.trimEnd=n/100,t.isPlaying&&t.play(c)):"speed"===a&&(t.setLocalRate(n),t.updateLivePlaybackRate(c))},"speed"===e.dataset.type&&e.addEventListener("dblclick",e=>{e.target.value=1,t.setLocalRate(1),t.updateLivePlaybackRate(c)})}),N.appendChild(n)}(o),ke(a);De(a,0,Xe(o)),o.play(c),Se(a,!0)}function Se(e,t){const n=document.getElementById(`play-btn-${e}`);n&&(n.classList.toggle("playing",t),n.innerHTML=t?"■":"▶")}function ke(e){d=e,document.querySelectorAll(".loop-item").forEach(e=>e.classList.remove("selected"));const t=document.getElementById(`track-${e}`);t&&t.classList.add("selected"),document.querySelectorAll(".select-btn").forEach(e=>{e.classList.remove("active"),e.innerText="EDIT FX"});const n=document.getElementById(`sel-btn-${e}`);n&&(n.classList.add("active"),n.innerText="EDITING"),F&&F.classList.add("hidden"),A&&A.classList.remove("hidden");const a=r.find(t=>t.id===e);O&&(O.innerText=a.name),Y.forEach(e=>{e.classList.remove("selected"),e.dataset.fx===a.currentEffect&&e.classList.add("selected")}),Ne(a.effectParams.x,a.effectParams.y),Re(a.currentEffect)}function Re(e){const t=document.getElementById("labelX"),n=document.getElementById("labelY");"filter"===e||"highpass"===e||"bandpass"===e?(t.innerText="X: Cutoff",n.innerText="Y: Res"):"autofilter"===e||"phaser"===e?(t.innerText="X: Rate",n.innerText="Y: Depth"):"flanger"===e?(t.innerText="X: Rate",n.innerText="Y: Feedback"):"chorus"===e||"tremolo"===e||"vibrato"===e?(t.innerText="X: Rate",n.innerText="Y: Depth"):"delay"===e||"echo"===e||"pingpong"===e?(t.innerText="X: Time",n.innerText="Y: Feedback"):"reverb"===e?(t.innerText="X: Size",n.innerText="Y: Mix"):"distortion"===e||"overdrive"===e||"saturation"===e?(t.innerText="X: Drive",n.innerText="Y: Tone"):"bitcrusher"===e?(t.innerText="X: Bits",n.innerText="Y: Rate"):"compressor"===e?(t.innerText="X: Thresh",n.innerText="Y: Ratio"):"limiter"===e?(t.innerText="X: Thresh",n.innerText="Y: Release"):"widener"===e?(t.innerText="X: Width",n.innerText="Y: Mix"):"panner"===e?(t.innerText="X: Pan",n.innerText="Y: Level"):"pitch"===e?(t.innerText="X: Shift",n.innerText="Y: Mix"):"harmonizer"===e?(t.innerText="X: Interval",n.innerText="Y: Mix"):"granular"===e?(t.innerText="X: Grain",n.innerText="Y: Spray"):(t.innerText="X: --",n.innerText="Y: --")}document.addEventListener("keydown",e=>{if(e.repeat)return;if(e.target&&["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName))return;const t=be(e.key);if(null===t)return;we(t),Ie(t,M,!0);const n=document.querySelector(`.pad-btn[data-pad="${t}"]`);n&&n.classList.add("active")}),document.addEventListener("keyup",e=>{const t=be(e.key);if(null===t)return;const n=document.querySelector(`.pad-btn[data-pad="${t}"]`);n&&n.classList.remove("active")}),j&&G&&(j.addEventListener("click",()=>G.click()),G.addEventListener("change",async t=>{const n=t.target.files&&t.target.files[0];if(n)try{await async function(t){if(!t)return;const n=e();"suspended"===n.state&&await n.resume();const a=await t.arrayBuffer();Be(await n.decodeAudioData(a))}(n)}catch(e){alert("Load failed: "+e.message)}finally{G.value=""}})),ee&&(we(0),ee.addEventListener("click",e=>{const t=e.target.closest(".pad-btn");if(!t)return;const n=parseInt(t.dataset.pad,10);we(n),Ie(n,M,!0)})),ne&&de&&(ne.addEventListener("click",()=>de.click()),de.addEventListener("change",async t=>{const n=t.target.files&&t.target.files[0];if(n)try{await async function(t){if(!t)return;const n=e();"suspended"===n.state&&await n.resume();const a=await t.arrayBuffer(),i=await n.decodeAudioData(a);T[I].buffer=i,Te(I)}(n)}catch(e){alert("Pad load failed: "+e.message)}finally{de.value=""}})),ae&&ae.addEventListener("click",async function(){const t=e();if("suspended"===t.state&&await t.resume(),B&&"inactive"!==B.state)B.stop();else try{const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}},n=await navigator.mediaDevices.getUserMedia(e);k=n,B=new MediaRecorder(n),S=[],B.ondataavailable=e=>S.push(e.data),B.onstop=async()=>{try{const e=new Blob(S,{type:"audio/ogg; codecs=opus"}),n=await e.arrayBuffer(),a=await t.decodeAudioData(n);T[I].buffer=a,Te(I)}catch(e){alert("Pad record failed: "+e.message)}finally{k&&(k.getTracks().forEach(e=>e.stop()),k=null),ae&&(ae.classList.remove("active"),ae.innerText="Record Pad")}},B.start(),ae&&(ae.classList.add("active"),ae.innerText="Stop Pad")}catch(e){alert("Microphone Error: "+e.message)}}),ie&&(ge(),ie.addEventListener("click",()=>{M=!M,ge()})),re&&(ye(),re.addEventListener("click",()=>{R=!R,R&&!h&&ze(),ye()})),oe&&oe.addEventListener("click",()=>{P.events=[],Ae()}),se&&se.addEventListener("click",()=>{!async function(){const e={version:1,pads:[]};for(let t=0;t<T.length;t++){const n=T[t];let i=null;if(n.buffer){const e=a(n.buffer,n.buffer.length);i=await Ee(e)}e.pads.push({name:n.name,key:Le[t]?Le[t].toUpperCase():"",sample:i})}const t=new Blob([JSON.stringify(e)],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`drum_preset_${Date.now()}.json`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(n)}()}),ce&&le&&(ce.addEventListener("click",()=>le.click()),le.addEventListener("change",async t=>{const n=t.target.files&&t.target.files[0];if(n)try{await async function(t){const n=e(),a=await t.text();let i;try{i=JSON.parse(a)}catch(e){return void alert("Invalid preset file.")}if(i&&Array.isArray(i.pads)){for(let e=0;e<T.length;e++){const t=i.pads[e];if(T[e].name=t&&t.name?t.name:`Pad ${e+1}`,T[e].buffer=null,t&&t.sample)try{const a=await fetch(t.sample).then(e=>e.arrayBuffer());T[e].buffer=await n.decodeAudioData(a)}catch(t){console.warn("Failed to load pad sample",e,t)}Te(e)}we(I),Ae()}else alert("Invalid preset structure.")}(n)}catch(e){alert("Preset load failed: "+e.message)}finally{le.value=""}})),Y.forEach(e=>{e.addEventListener("click",e=>{if(!d)return;const t=e.target.dataset.fx;r.find(e=>e.id===d).setEffect(t),Y.forEach(e=>e.classList.remove("selected")),e.target.classList.add("selected"),Re(t)})});let Pe=!1;function Ce(e){if(!d)return;const t=X.getBoundingClientRect();let n=Math.max(0,Math.min(e.clientX-t.left,t.width)),a=Math.max(0,Math.min(e.clientY-t.top,t.height));const i=n/t.width,o=1-a/t.height;Ne(i,o);const s=r.find(e=>e.id===d);s&&s.updateEffectParams(i,o)}function Ne(e,t){D&&(D.style.left=100*e+"%",D.style.top=100*(1-t)+"%")}X&&(X.addEventListener("mousedown",e=>{Pe=!0,Ce(e)}),window.addEventListener("mouseup",()=>{Pe=!1}),window.addEventListener("mousemove",e=>{Pe&&Ce(e)})),document.getElementById("playAllBtn").addEventListener("click",()=>{ze()}),document.getElementById("stopAllBtn").addEventListener("click",()=>{je(),r.forEach(e=>{e.stop(),Se(e.id,!1)}),R&&(R=!1,ye())});let $e=!1;function Xe(e){const t=e.buffer.duration*(e.trimEnd-e.trimStart),n=Math.max(.1,e.localRate);return Math.max(u,t/n)}function De(e,t,n){const a=me(),i=w?pe(t):t;let r=n;w&&a>0&&(r=Math.round(n/a)*a);const o={id:p++,trackId:e,start:Math.max(0,i),duration:Math.max(u,r)};m.push(o),Ae()}function Ae(){if(!Q||!J)return;const e=function(){const e=m.reduce((e,t)=>Math.max(e,t.start+t.duration),0);return Math.max(60,Math.ceil(e+5))}();x=e;const t=e*l;J.innerHTML="",J.style.width=`${t}px`;const n=ue(),a=Math.ceil(e/n);for(let e=0;e<=a;e++){const t=document.createElement("div"),a=e%4==0;if(t.className="timeline-tick"+(a?" major":""),t.style.left=e*n*l+"px",J.appendChild(t),a){const t=document.createElement("div");t.className="timeline-tick-label",t.style.left=e*n*l+"px",t.innerText=`${Math.floor(e/4)+1}`,J.appendChild(t)}}!function(){if(!J)return;E.end-E.start<u&&(E.end=E.start+1);E.start=Math.max(0,Math.min(E.start,x-u)),E.end=Math.max(E.start+u,Math.min(E.end,x));const e=document.createElement("div");e.className="timeline-loop-region",e.style.left=E.start*l+"px",e.style.width=(E.end-E.start)*l+"px",e.innerText=y?"LOOP":"REGION";const t=document.createElement("div");t.className="loop-handle left";const n=document.createElement("div");if(n.className="loop-handle right",e.appendChild(t),e.appendChild(n),e.addEventListener("mousedown",e=>qe(e,"move")),t.addEventListener("mousedown",e=>qe(e,"resize-left")),n.addEventListener("mousedown",e=>qe(e,"resize-right")),e.addEventListener("dblclick",e=>e.stopPropagation()),J.appendChild(e),Z){Z.style.left=E.start*l+"px",Z.style.width=(E.end-E.start)*l+"px";const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--timeline-row-height"))||56,t=ve();Z.style.height=`${t+r.length*e}px`}}(),Q.innerHTML="";const i=document.createElement("div");i.className="timeline-row drum-row";const o=document.createElement("div");o.className="timeline-label",o.innerText="DRUMS";const d=document.createElement("div");d.className="timeline-lane drum-lane",d.style.width=`${t}px`;const s=ve()/T.length;T.forEach((e,t)=>{const n=document.createElement("div");n.className="drum-subrow",n.dataset.pad=t,n.style.top=t*s+"px",d.appendChild(n)}),P.events.forEach(e=>{const t=document.createElement("div");t.className="drum-hit",t.dataset.pad=e.padIndex,t.dataset.time=e.time,t.style.left=e.time*l+"px",t.style.top=e.padIndex*s+"px",t.style.width=`${Math.max(10,me()*l-2)}px`,t.innerText=Le[e.padIndex]?Le[e.padIndex].toUpperCase():"",t.addEventListener("click",e=>{e.stopPropagation();const n=parseInt(t.dataset.pad,10),a=parseFloat(t.dataset.time),i=P.events.findIndex(e=>e.padIndex===n&&Math.abs(e.time-a)<5e-4);-1!==i&&P.events.splice(i,1),Ae()}),d.appendChild(t)}),d.addEventListener("click",e=>{const t=d.getBoundingClientRect(),n=W?W.scrollLeft:0,a=Math.max(0,e.clientX-t.left+n),i=Math.max(0,e.clientY-t.top);Me(Math.min(T.length-1,Math.max(0,Math.floor(i/s))),a/l,!1),Ae()}),i.appendChild(o),i.appendChild(d),Q.appendChild(i),r.forEach(e=>{const n=document.createElement("div");n.className="timeline-row";const a=document.createElement("div");a.className="timeline-label",a.innerText=e.name;const i=document.createElement("div");i.className="timeline-lane",i.dataset.trackId=e.id,i.style.width=`${t}px`,i.addEventListener("dblclick",t=>{const n=i.getBoundingClientRect(),a=W?W.scrollLeft:0,r=Math.max(0,t.clientX-n.left+a)/l;De(e.id,r,Xe(e))}),m.filter(t=>t.trackId===e.id).forEach(t=>{const n=document.createElement("div");n.className="timeline-clip",n.dataset.clipId=t.id,n.style.left=t.start*l+"px",n.style.width=t.duration*l+"px",n.innerText=e.name;const a=document.createElement("div");a.className="clip-handle left";const r=document.createElement("div");r.className="clip-handle right",n.appendChild(a),n.appendChild(r),n.addEventListener("mousedown",e=>Ye(e,t.id,"move")),n.addEventListener("dblclick",e=>e.stopPropagation()),a.addEventListener("mousedown",e=>Ye(e,t.id,"resize-left")),r.addEventListener("mousedown",e=>Ye(e,t.id,"resize-right")),i.appendChild(n)}),n.appendChild(a),n.appendChild(i),Q.appendChild(n)})}z&&z.addEventListener("click",async()=>{if(!d)return;const t=e(),n=r.find(e=>e.id===d);if($e)i&&"inactive"!==i.state&&i.stop(),n.stop(),Se(n.id,!1),z.innerHTML="⚠ Resample (Record FX)",z.classList.remove("active"),C.disabled=!1,z.style.background="#d68a28",$e=!1;else{C.disabled=!0;const e=t.createMediaStreamDestination();n.gainNode.connect(e),i=new MediaRecorder(e.stream),o=[],i.ondataavailable=e=>o.push(e.data),i.onstop=async()=>{const a=new Blob(o,{type:"audio/ogg; codecs=opus"}),i=await a.arrayBuffer();Be(await t.decodeAudioData(i)),n.gainNode.disconnect(e)},i.start(),n.play(c),Se(n.id,!0),$e=!0,z.innerHTML="■ STOP RESAMPLE",z.style.background="#ff4444",z.classList.add("active")}});let Fe=null,Oe=null;function Ye(e,t,n){e.stopPropagation(),e.preventDefault();const a=m.find(e=>e.id===t);a&&(Fe={clipId:t,mode:n,startX:e.clientX,origStart:a.start,origDuration:a.duration})}function qe(e,t){e.stopPropagation(),e.preventDefault(),Oe={mode:t,startX:e.clientX,origStart:E.start,origEnd:E.end}}function Ue(){const e=document.querySelector(".timeline-loop-region");if(e&&(e.style.left=E.start*l+"px",e.style.width=(E.end-E.start)*l+"px",e.innerText=y?"LOOP":"REGION"),Z){Z.style.left=E.start*l+"px",Z.style.width=(E.end-E.start)*l+"px";const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--timeline-row-height"))||56,t=ve();Z.style.height=`${t+r.length*e}px`}}function ze(){const t=e();if(je(),0===m.length)return;r.forEach(e=>{e.stop(),Se(e.id,!1)}),f=[],h=!0;const n=t.currentTime+.05;if(g=y?n-E.start:n,y){const e=Math.max(u,E.end-E.start);let a=n;const i=()=>{if(!h||!y)return;Ge(a,E.start,E.end),a+=e;const n=Math.max(20,1e3*(a-t.currentTime-.1));v=window.setTimeout(i,n)};i()}else Ge(n,0,Number.POSITIVE_INFINITY)}function je(){f.forEach(e=>{try{e.stop()}catch(e){}try{e.disconnect()}catch(e){}}),f=[],h=!1,v&&(window.clearTimeout(v),v=null)}function Ge(t,n,a){const i=e();!function(t,n,a){if(!P.events.length)return;const i=e(),r=t-n,o=y?E.start:0,d=y?E.end-E.start:P.length||4*ue(),s=Math.max(u,d);P.events.forEach(e=>{if(!T[e.padIndex]||!T[e.padIndex].buffer)return;let t=o+e.time;if(y&&(t=o+e.time%s),t<n||t>=a)return;const d=r+t;if(d<i.currentTime)return;const c=i.createBufferSource();c.buffer=T[e.padIndex].buffer,c.connect(i.destination),c.start(d),f.push(c)})}(t,n,a),m.forEach(e=>{const o=e.start,d=e.start+e.duration,s=Math.max(o,n),l=Math.min(d,a);if(l<=s)return;const u=r.find(t=>t.id===e.trackId);if(!u)return;const m=i.createBufferSource();m.buffer=u.buffer,m.loop=!0;const p=u.buffer.duration;m.loopStart=p*u.trimStart,m.loopEnd=p*u.trimEnd,m.loopEnd-m.loopStart<.01&&(m.loop=!1);const h=u.localRate*c,g=Math.max(.1,Math.min(h,4));m.playbackRate.value=g;const y=s-o,v=m.loopStart+y*g,E=t+(s-n),x=t+(l-n);m.connect(u.fxInput),m.start(E,v),m.stop(x),f.push(m)})}window.addEventListener("mousemove",e=>{if(!Fe)return;const t=m.find(e=>e.id===Fe.clipId);if(!t)return;const n=(e.clientX-Fe.startX)/l,a=fe(e);if("move"===Fe.mode){const e=Fe.origStart+n,i=a?pe(e):e;t.start=Math.max(0,i)}else if("resize-left"===Fe.mode){const e=Fe.origStart+Fe.origDuration;let i=Fe.origStart+n;a&&(i=pe(i)),i=Math.max(0,Math.min(i,e-u)),t.start=i,t.duration=Math.max(u,e-i)}else if("resize-right"===Fe.mode){let e=Fe.origStart+Fe.origDuration+n;a&&(e=pe(e)),t.duration=Math.max(u,e-Fe.origStart)}const i=document.querySelector(`.timeline-clip[data-clip-id="${t.id}"]`);i&&(i.style.left=t.start*l+"px",i.style.width=t.duration*l+"px")}),window.addEventListener("mouseup",()=>{Fe&&(Fe=null,Ae())}),window.addEventListener("mousemove",e=>{if(!Oe)return;const t=(e.clientX-Oe.startX)/l,n=fe(e);if("move"===Oe.mode){const e=Oe.origEnd-Oe.origStart;let a=Oe.origStart+t;n&&(a=pe(a)),a=Math.max(0,Math.min(a,x-e)),E.start=a,E.end=a+e}else if("resize-left"===Oe.mode){let e=Oe.origStart+t;n&&(e=pe(e)),e=Math.max(0,Math.min(e,E.end-u)),E.start=e}else if("resize-right"===Oe.mode){let e=Oe.origEnd+t;n&&(e=pe(e)),e=Math.max(E.start+u,Math.min(e,x)),E.end=e}Ue()}),window.addEventListener("mouseup",()=>{Oe&&(Oe=null,Ae(),h&&y&&ze())});const He=document.getElementById("exportBtn");He&&He.addEventListener("click",async()=>{if(0===r.length)return alert("No tracks to export.");const e=He.innerText;He.innerText="Rendering...",He.disabled=!0;try{let e=0;r.forEach(t=>{const n=t.buffer.duration*(t.trimEnd-t.trimStart)/(t.localRate*c);n>e&&(e=n)});const t=Math.max(4*e,10),i=new OfflineAudioContext(2,Math.ceil(44100*t),44100);r.forEach(e=>{const t=new n(e.id,e.buffer,"Ghost");t.initAudioGraph(i),t.currentEffect=e.currentEffect,t.effectParams=e.effectParams,t.trimStart=e.trimStart,t.trimEnd=e.trimEnd,t.localRate=e.localRate,t.refreshEffectRouting(),t.updateEffectParams(e.effectParams.x,e.effectParams.y),t.gainNode.connect(i.destination);const a=i.createBufferSource();a.buffer=e.buffer,a.loop=!0;const r=e.buffer.duration;a.loopStart=r*e.trimStart,a.loopEnd=r*e.trimEnd,a.loopEnd-a.loopStart<.01&&(a.loop=!1);const o=e.localRate*c;a.playbackRate.value=o,a.connect(t.fxInput),a.start(0,a.loopStart)});const o=await i.startRendering(),d=a(o,o.length),s=URL.createObjectURL(d),l=document.createElement("a");l.href=s,l.download=`LoopStation_Mix_${Date.now()}.wav`,document.body.appendChild(l),l.click(),l.remove()}catch(e){console.error(e),alert("Export failed: "+e.message)}He.innerText=e,He.disabled=!1}),Ae();
//# sourceMappingURL=main.js.map